name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop, 'claude/**' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm install -g jpm eslint
          npm install --save-dev eslint

      - name: Run ESLint
        run: eslint index.js lib/*.js test/*.js

      - name: Check code formatting
        run: |
          # Check for trailing whitespace
          ! git grep -I --line-number --perl-regexp '\s+$' -- ':!*.md' || \
            (echo "Error: Found trailing whitespace" && exit 1)

  test:
    name: Run Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install jpm
        run: npm install -g jpm

      - name: Install Firefox Nightly (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y wget
          wget -O firefox-nightly.tar.bz2 \
            "https://download.mozilla.org/?product=firefox-nightly-latest&os=linux64&lang=en-US"
          tar -xjf firefox-nightly.tar.bz2
          echo "FIREFOX_PATH=$(pwd)/firefox/firefox" >> $GITHUB_ENV

      - name: Install Firefox Nightly (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install --cask firefox-nightly
          echo "FIREFOX_PATH=/Applications/Firefox Nightly.app" >> $GITHUB_ENV

      - name: Run tests
        run: jpm test -b "$FIREFOX_PATH"

  build:
    name: Build XPI
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install jpm
        run: npm install -g jpm

      - name: Build XPI
        run: make xpi

      - name: Verify XPI created
        run: |
          if [ ! -f zotero-voyant-export.xpi ]; then
            echo "Error: XPI file not created"
            exit 1
          fi
          ls -lh zotero-voyant-export.xpi

      - name: Upload XPI artifact
        uses: actions/upload-artifact@v4
        with:
          name: zotero-voyant-export-xpi
          path: zotero-voyant-export.xpi
          retention-days: 30

  rsr-compliance:
    name: RSR Compliance Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install just
        uses: extractions/setup-just@v1

      - name: Run RSR compliance check
        run: just rsr-check

      - name: Verify documentation
        run: |
          echo "Checking required documentation files..."
          MISSING=""
          for file in README.md LICENSE SECURITY.md CONTRIBUTING.md \
                      CODE_OF_CONDUCT.md MAINTAINERS.md CHANGELOG.md \
                      CLAUDE.md DEVELOPMENT.md BAGIT.md TPCF.md RSR_COMPLIANCE.md; do
            if [ ! -f "$file" ]; then
              MISSING="$MISSING $file"
            fi
          done

          if [ -n "$MISSING" ]; then
            echo "Error: Missing documentation files:$MISSING"
            exit 1
          fi
          echo "✓ All documentation files present"

      - name: Verify .well-known directory
        run: |
          echo "Checking .well-known directory..."
          for file in security.txt ai.txt humans.txt; do
            if [ ! -f ".well-known/$file" ]; then
              echo "Error: Missing .well-known/$file"
              exit 1
            fi
          done
          echo "✓ All .well-known files present"

      - name: Check security.txt expiration
        run: |
          EXPIRES=$(grep "Expires:" .well-known/security.txt | cut -d: -f2-)
          EXPIRES_DATE=$(date -d "$EXPIRES" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%S" "$EXPIRES" +%s)
          NOW=$(date +%s)

          if [ $EXPIRES_DATE -lt $NOW ]; then
            echo "Warning: security.txt has expired"
            exit 1
          fi
          echo "✓ security.txt is valid"

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run secret scanning
        run: |
          echo "Scanning for exposed secrets..."
          if git grep -i "password\s*=\|secret\s*=\|api_key\s*=\|token\s*=" -- '*.js' '*.json'; then
            echo "Error: Potential secrets found in code"
            exit 1
          fi
          echo "✓ No secrets found"

      - name: Check for security TODOs
        run: |
          if git grep -i "TODO.*security\|FIXME.*security" -- '*.js' '*.md'; then
            echo "Warning: Security-related TODOs found"
          fi

      - name: Verify SECURITY.md
        run: |
          if [ ! -f SECURITY.md ]; then
            echo "Error: SECURITY.md is missing"
            exit 1
          fi
          echo "✓ SECURITY.md present"

  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Check for JSDoc comments
        run: |
          echo "Checking for JSDoc coverage..."
          # Count functions without JSDoc
          MISSING=$(grep -r "^const.*= (.*) =>" lib/*.js | \
                    grep -v "/\*\*" | wc -l || echo 0)

          if [ $MISSING -gt 0 ]; then
            echo "Warning: $MISSING functions may be missing JSDoc"
          else
            echo "✓ Good JSDoc coverage"
          fi

      - name: Check documentation links
        run: |
          echo "Checking for broken internal links..."
          # Basic check for referenced files that don't exist
          for file in *.md; do
            # Extract markdown links
            grep -o '\[.*\](.*.md)' "$file" | sed 's/.*(\(.*\))/\1/' | while read link; do
              if [ ! -f "$link" ]; then
                echo "Warning: Broken link in $file: $link"
              fi
            done
          done

  stats:
    name: Project Statistics
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install just
        uses: extractions/setup-just@v1

      - name: Generate statistics
        run: just stats

      - name: Count lines of code
        run: |
          echo "## Project Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Code" >> $GITHUB_STEP_SUMMARY
          find . -name "*.js" -not -path "./node_modules/*" -not -path "./.git/*" \
            | xargs wc -l | tail -1 >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Documentation" >> $GITHUB_STEP_SUMMARY
          find . -name "*.md" -not -path "./node_modules/*" -not -path "./.git/*" \
            | xargs wc -l | tail -1 >> $GITHUB_STEP_SUMMARY

  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [lint, test, build, rsr-compliance, security]
    if: failure()
    steps:
      - name: Report failure
        run: |
          echo "❌ CI/CD Pipeline failed"
          echo "Please check the failed jobs above"
